<script>
    document.getElementById("stockForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const ticker = document.getElementById("ticker").value;
        const chartElement = document.getElementById("stockChart");
        
        // It's good practice to have a loading indicator, but for now, let's just clear the old chart
        if (window.myStockChart) {
            window.myStockChart.destroy();
        }

        try {
            const response = await fetch(`/api/price?ticker=${ticker}`);

            // Check if the server responded with an error status (e.g., 400, 500)
            if (!response.ok) {
                // Try to get the error message from the response body
                const errorData = await response.json().catch(() => ({ error: `HTTP error! Status: ${response.status}` }));
                throw new Error(errorData.error);
            }

            const data = await response.json();

            // Check for application-specific errors in a successful response body
            if (data.error) {
                throw new Error(data.error);
            }

            // The API response structure can vary. Check if the required data is present.
            const timeSeries = data["Time Series (Daily)"];
            if (!timeSeries) {
                throw new Error("Received an unexpected data format from the API.");
            }

            const times = Object.keys(timeSeries).reverse();
            const prices = times.map(t => timeSeries[t]["4. close"]); 

            // Create the new chart
            window.myStockChart = new Chart(chartElement, {
                type: "line",
                data: {
                    labels: times,
                    datasets: [{ 
                        label: ticker.toUpperCase(), 
                        data: prices, 
                        borderColor: "rgba(75, 192, 192, 1)",
                        fill: false 
                    }]
                }
            });

        } catch (error) {
            console.error('Error fetching or displaying stock data:', error);
            alert(`An error occurred: ${error.message}`);
        }
    });
</script>